---
title: "Manejo  de datos"
subtitle: "Transformar datos en R con dplyr"
format: 
  revealjs:
    theme: solarized 
    smaller: true
    slide-number: true 
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
    theme-font-size: 0.5
---

## Manejo de datos

### La exploraci√≥n de datos es el primer paso para:

-   Verificar su calidad
-   Comprender la informaci√≥n con la que trabajamos
-   Detectar errores o valores at√≠picos
-   Preparar los datos para su an√°lisis o visualizaci√≥n

## Buenas pr√°cticas en el manejo de datos



### Nombres y valores üß© 

-   Evita espacios, n√∫meros o caracteres especiales en los nombres de columnas
-   No combines varias informaciones en una misma celda
-   Anota los ceros (0) cuando existen ‚Äî no los dejes vac√≠os!!
-   Usa NA o celdas vac√≠as para indicar datos faltantes
-   Separa las fechas en columnas: year, month, day

## Organizacion tabla

![Hertz & McNeill 2024](images/example-table.png){style="font-size:30px"}

## Tidyverse

::::: columns
::: {.column width="50%"}

### El universo ordenado

El tidyverse es una colecci√≥n de paquetes de R 

- Para hacer m√°s f√°cil y coherente el trabajo con datos. 
- Los datos deben ser ordenados (tidy)
- El c√≥digo legible 
- Resultados reproducibles



:::

::: {.column width="50%"}
### Estructura y formato

-   Cada variable en una columna
-   Cada observaci√≥n en una fila
-   Cada valor tiene su propia celda

![Ejemplo organizaci√≥n "tidy"](images/tidy-table.png)
:::
:::::

## Tidyverse
```{r}
#| echo: true

tidyverse::tidyverse_packages()
```

### Pipes 
- %>% y |>

```{r}
#| echo: true

library(dplyr)

# El propio de dplyr  (control  (command) + shift + M)
iris %>%
  filter(Sepal.Length > 5) %>%
  summarise(promedio = mean(Sepal.Width)) 

# el de R desde hace unos a√±os
iris |>
  filter(Sepal.Length > 5) |>
  summarise(promedio = mean(Sepal.Width))

```
- C√≥mo encadenar operaciones: los "pipes" permiten escribir c√≥digo paso a paso, de forma legible.

## Empecemos con el manejo de datos
-   Vamos a trabajar exclusivamente con dplyr
-   tip: qu√© queremos hacer con los datos (escribir a mano?)

## Leer, observar los datos
Nuestro ejemplo: **ping√ºinos** (penguins) \
Tres especies en tres islas distintas datos recogidos durante tres a√±os.\
Datos sobre la longitud y profundidad del pico, la aleta, peso.
![penguins data presentation"](images/penguins.png)


## Leer, observar los datos
```{r}
#| echo: true

library(dplyr)
library(palmerpenguins)
library(scico)

data(package = 'palmerpenguins')
glimpse (penguins)

```

------------------------------------------------------------------------

## Importante
```{r}
#| echo: true
#| eval: false

BASE DE DATOS %>%
    FUNCION (nombre_nuevo = hacemos algo aqu√≠ dentro,
             nombre_nuevo_2 = que esto == sea igual a esto) %>%
    OTRAFUNCION (calculamos la media) %>%
    ULTIMAFUNCION (filtramos por unos datos,
                   filtramos por otra columna)
```

## 1. Renombrar las variables con 'rename'
Traducir al espa√±ol

```{r}
#| echo: true

penguins %>% rename (long_pico = bill_length_mm)

```

## 1. Renombrar las variables con 'rename'
Traducir todas las columnas al espa√±ol

```{r}
#| echo: true

penguins %>% rename (long_pico = bill_length_mm, 
                     anchura_pico = bill_depth_mm, 
                     long_aleta = flipper_length_mm, 
                     masa = body_mass_g,
                     sexo = sex,
                     a√±o = year,
                     especies = species,
                     isla = island)

```

## 2. Seleccionar columnas con 'select'

Queremos todas las columnas, menos la de la isla

```{r}
#| echo: true

penguins %>% select (island, bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g, sex, year)
penguins %>% select (-species) #ser√≠a lo mismo

```
## 2. Seleccionar columnas con 'select'

Queremos todas las columnas, menos la del a√±o y la del sexo del ping√ºino.

```{r}
#| echo: true
# concatenamos variables con c()
penguins %>% select (-c(sex, year))
```

## 2. Seleccionar columnas con 'select'

Podemos seleccionar, cambiar el orden y renombrar al mismo tiempo con 'select'

```{r}
#| echo: true

penguins %>% select (year, sex, species, 
                     long_pico = bill_length_mm, 
                     anchura_pico = bill_depth_mm, 
                     long_aleta = flipper_length_mm)
```

## 3. Contar valores con 'count'

```{r}
#| echo: true

# ¬øCu√°ntos valores hay por isla? (n√∫mero de filas)
penguins %>%
  count(island)

# ¬øCu√°ntos valores hay por isla y por especie?
penguins %>%
  count(species, island)

```

## 4. Valores √∫nicos con 'distinct'

```{r}
#| echo: true

penguins %>%
  distinct(island)

penguins %>%
  distinct(species, island)

```

## 5. Filtrar con 'filter'

Filtrar por un valor (asignaciones l√≥gicas)
```{r}
#| echo: true
# recordad: == para condici√≥n l√≥gica de "igual a"
penguins_filtered  <- penguins %>% filter (year == 2007)

```

Filtrar por varios valores
```{r}
#| echo: true

penguins_filtered  <- penguins %>% filter (year == 2007, sex == "female")
```

Filtrar por varios valores que incluyen varias condiciones
```{r}
#| echo: true

penguins_filtered  <- penguins %>% 
  filter (year > 2008, sex == "female", 
          island %in% c("Dream", "Biscoe"))

penguins_filtered %>%
  select (island, year, sex) %>% 
  distinct()
```

## 5. Filtrar con 'filter'

Filtrar fuera, quitar valores
```{r}
#| echo: true

penguins_filtered <- penguins %>%
  filter(!is.na(body_mass_g))

penguins_filtered <- penguins %>%
  filter(year != 2007)

penguins_filtered <- penguins %>%
  filter(!year == 2007)

penguins_filtered %>% select(year) %>% distinct()

```

## 6. Transformar variables con 'mutate'

Crear nuevas variables
```{r}
#| echo: true

# Masa en kg
penguins_mut <- penguins %>%
  mutate(body_mass_kg = body_mass_g / 1000) 

# Ratio del pico
penguins %>%
  mutate(bill_ratio = bill_length_mm / bill_depth_mm) %>%
  select(bill_length_mm, bill_depth_mm, bill_ratio)

```
## 7. Resumir variables con 'summarise'

Dentro de summarise podemos hacer operaciones que van asignadas a una variable con un nombre nuevo.

```{r}
#| echo: true

penguins %>%
  summarise (mean (body_mass_g, na.rm = TRUE))

# A√±adimos nombre de la columna nueva
penguins %>%
  summarise (promedio_pico = mean (body_mass_g, na.rm = TRUE))

# Podemos hacer otros c√°lculos
penguins %>% 
  group_by (species) %>%
  summarise (promedio_peso_kg = mean (body_mass_g, na.rm = TRUE)/1000)

```

Muy √∫til para explorar los datos y resumirlos en una tabla para un art√≠culo.

## 8. Agrupar variables con 'group_by'

```{r}
#| echo: true

penguins %>% 
  group_by(species) %>%
  summarise (promedio_peso_kg = mean (body_mass_g, na.rm = TRUE)/1000)

penguins %>% 
  group_by(species) %>%
  summarise (promedio_peso_kg = mean (body_mass_g, na.rm = TRUE)/1000,
             conteo_a√±os = n_distinct(year)
  )
```

## 9. Aplicar condiciones con 'if_else'
Muy √∫til para corregir datos

```{r}
#| echo: true
# Queremos que data vez que ponga 2008, sea en realidad 2010
penguins_filtered <- penguins %>%
  mutate(year_2 = if_else(year == 2008, 2010, year))

penguins %>%
  mutate(year_2 = if_else(year == 2008, 2010, year)) %>%
  arrange(desc(year_2)) %>% select (year, year_2) %>% distinct()

# Que los NA en realidad corresponden con los polluelos
penguins_filtered <- penguins %>% 
  mutate (family = if_else(is.na(sex), "chick", sex))

penguins %>% 
  mutate (family = if_else(is.na(sex), "chick", sex)) %>% 
   select (sex, family) %>% distinct()
```

## 9. Aplicar condiciones con 'if_else'

O reclasificar: convertir el sexo en una categor√≠a binaria o dummy

```{r}
#| echo: true
penguins %>% 
  mutate (sex_binary = if_else(sex=="male", 0, 1))

```

## Otras funciones interesantes

- case_when () para filtrar datos por casos\
- pivot_wider () para convertir a formato corto\
- pivor_longer () para convertir a formato largo\
- arrange () ordenar de mayor a menor, menor a mayor
- relotate () cambiar las columnas de orden

Sois autodidactas (bibliograf√≠a, chatgpt, google, stackoverflow, etc)

## 10. Combinar dos bases de datos con 'join'
1) datos con los nombres taxon√≥micos (nombres de las especies)\
2) datos con los rasgos de las especies\

```{r}
#| echo: true

taxonomy <- data.frame (species = unique(penguins$species),
                    species_name = c("Pygoscelis adeliae",  
                                     "Pygoscelis papua", 
                                     "Pygoscelis antarcticus"))
taxonomy
```
Ambas tienen la especie en com√∫n\
```{r}
#| echo: true

setdiff(taxonomy$species, penguins$species)

penguins_join <- penguins %>% 
  left_join (taxonomy, by ="species") 
glimpse(penguins)
```

***
```{r}
#| echo: true

library(DT)
datatable(penguins_join)


```

## Ejemplo datos inscripci√≥n curso

```{r}
#| echo: true

library(tm)
library(wordcloud2)
library(readxl)
library(here)
library(stringr)

datos_curso <- read_excel(here("data/datos-curso.xlsx"))
datos_curso
```


***
¬øQu√© otra funci√≥n podr√≠amos usar para ver los datos?

```{r}
#| echo: true

colnames(datos_curso) # Miramos las columnas que tiene
```

***
```{r}
#| echo: true

glimpse(datos_curso) 
```

***
### Vamos a filtrar y ordenar un poco nuestra bbdd

```{r}
#| echo: true

datos_curso_filtrado <- datos_curso %>%
  rename (
    curso = "Curso de la primera matr√≠cula en el programa de doctorado",
    experiencia = "Cu√©ntanos tu experiencia con R",
    comentarios = "Observaciones",
    email = "Correo electr√≥nico"
  ) %>%
  select (curso, experiencia, comentarios, email) %>%
  mutate (email = str_replace(email, "anonymous", "an√≥nimo")) 

glimpse(datos_curso_filtrado)

```
***

```{r}
#| echo: true

words <- tolower(unlist(strsplit(datos_curso_filtrado$experiencia, " ")))

words <- gsub("[[:punct:][:digit:]]", "", words)
stop_es <- stopwords("spanish")
words_clean <- words[!words %in% stop_es]

# Plot
word_course_r <-  wordcloud2(
  data = table(words_clean),
  size = 0.5,
  color = rep(RColorBrewer::brewer.pal(11, "PRGn"), 20)
)

```

![WordCloud](images/wordcloud.png)

```{r}
#| echo: false

datos_curso_filtrado <- datos_curso |> 
  rename (
    curso = "Curso de la primera matr√≠cula en el programa de doctorado",
    experiencia = "Cu√©ntanos tu experiencia con R",
    comentarios = "Observaciones",
    email = "Correo electr√≥nico"
  ) |> 
  select (curso, experiencia, comentarios, email) |>
  mutate (email = str_replace(email, "anonymous", "an√≥nimo")) |>
  filter (curso == "2022-23")

words <- tolower(unlist(strsplit(datos_curso_filtrado$experiencia, " ")))

words <- gsub("[[:punct:][:digit:]]", "", words)
stop_es <- stopwords("spanish")
words_clean <- words[!words %in% stop_es]

# Plot
wordcloud2(
  data = table(words_clean),
  size = 0.5,
  color = rep(RColorBrewer::brewer.pal(11, "PRGn"), 4)
)


```

![WordCloud](images/wordcloud_filt.png)


## Ejercicios manejo de datos {.smaller}

#### Como ayer pero con dplyr! 

Base de datos de flores en Do√±ana

::::: columns
::: {.column width="50%"}

code = c√≥digo de la observaci√≥n\
site_id = lugar y numero de visita\
pantrap = n√∫mero de pantrap 1:9\
species = especie de planta\
abundance = n√∫mero de flores por individuo\

Ejercicio 1. Importa la base de datos "flores.csv" de la carpeta "data", explora la base de datos, calcula la abundancia media de flores total, indica cuantas especies distintas hay de plantas, crea una base de datos con el n√∫mero de registros (o individuos) por especie. Guardala como csv. 

:::

::: {.column width="50%"}
![Pantrap](images/pantrap.png)
:::
:::::

## Resolvemos


```{r}
#| echo: true

flores <- read.csv (here("data/flores.csv"))

# Estructura de los datos
glimpse (flores)

# Media de abundancia
flores %>% 
  summarise (media_abundancia = mean(abundance, na.rm = TRUE))

# N√∫mero de especies √∫nicas
flores %>% 
  summarise (n_especies = n_distinct(species))

# Listado de especies √∫nicas
flores %>% 
  distinct(species)

```
***

```{r}
#| echo: true

# Crea una base de datos con el n√∫mero de individuos por especie. Guardala como csv. 

# Conteo de registros por especie
count_flowers <- flores %>% count(species)
count_flowers

write.csv (count_flowers, here("data/count_flowers.csv"))

```

## Otro ejercicio ü™ê 

#### La base de datos "starwars" 

Tema: personajes de Star Wars (altura, peso, planeta, especie, etc.)

1.
Selecciona las columnas name, species, height, mass, homeworld\
Filtra solo humanos y droides\
Crea una columna con la variable del IMC\
Clasifica un IMC mayor de 25 en "alto" y menor en "bajo" en otra columna\
Guardalo en una base de datos nueva\

2.
Resume por especie la media de la masas y la altura en metros\
Qui√©n puede alcanzar una masa corporal mayor, los humanos o droides?

3. 
¬øQu√© personajes pesan m√°s de 100 kg y pertenecen a la especie Human?

4.
¬øCu√°ntos personajes hay por cada tipos de pelo? Si hay NA, crea una categor√≠a que sea "no_hair".


## Resolvemos
```{r}
#| echo: true

# glimpse (starwars)

#1
star_filtered <- starwars %>%
  select (name, species, height, mass, homeworld) %>%
  filter (species %in% c("Human", "Droid")) %>%
  mutate (imc = mass/(height/100)^2) %>%
  mutate (img_cat = if_else (imc > 25, "alto", "bajo"))


starwars %>%
  group_by(species) %>%
  summarise (mass_mean = mean (mass, na.rm = T),
             height_mean = mean (height, na.rm = T)/100)
```
## Resolvemos
```{r}
#| echo: true

#2
starwars %>%
 filter (species %in% c("Human", "Droid")) %>%
  group_by(species) %>%
  summarise (mass_max = max (mass, na.rm = T))
```
## Resolvemos
```{r}
#| echo: true

#3
starwars %>%
  filter (mass>100, species == "Human")
```
## Resolvemos
```{r}
#| echo: true

#4

starwars %>%
  mutate (hair_color = if_else (is.na(hair_color), "no_hear", hair_color)) %>%
  group_by (hair_color) %>%
  summarise (color = n_distinct(name))

```
