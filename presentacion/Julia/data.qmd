---
title: "Manejo y visualización de datos"
subtitle: "Importar, transformar y visualizar datos en R"
format: 
  revealjs:
    theme: solarized   
    slide-number: true 
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

## Manejo de datos

La exploración de datos nos permite verificar su calidad, entender los datos con los que trabajamos. Visualizar nuestros datos es un buen comienzo, pero a menudo vamos a necesitar transformar los datos previamente.

Formato tidy data

Cada variable tiene su propia columna Cada observación tiene su propia fila Cada valor tiene su propia celda

![Ejemplo organización "tidy"](images/tidy-table.png)

## Buenas prácticas en el manejo de datos

-   Las variables van en columnas (e.g. mediciones: altura, peso, sexo)
-   Las observaciones cada una en una fila (e.g. individuos de pingüinos)
-   Evitar espacios, números, y caracteres especiales en los nombres de columnas.
-   Siempre anotar valores de cero, para diferenciarlos de datos faltantes.
-   Usar celdas vacías o con NA para datos faltantes.
-   Las fechas incluirlas en columnas separadas como year, month, day.
-   No combinar varias informaciones en una misma celda.
-   Realiza todas las manipulaciones de datos mediante código para dejar constancia de los cambios.
-   Exporta los datos como texto plano (txt, csv)

## Ejemplo datos de pingüinos

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 1. Cargar librerías

library(dplyr)
library(ggplot2)
library(readr)
library(palmerpenguins)
library(scico)

# 2. Leer datos
data(package = 'palmerpenguins')
datos <- penguins

# 3. Explorar

head(datos)

unique(datos$island)

datos_filtrados <- datos %>% filter(year == 2007)

datos_filtrados <-datos %>% filter(year == 2007, sex=="female")

datos_filtrados <- datos %>% filter(year == 2007, sex=="female", island %in% c("Dream", "Bicoe")) 
# island == c("Dream", "Bicoe")) NO VALE!

head (datos_filtrados, 3)
```

## Limpiar los datos

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 4. Limpiar: eliminar filas con NA
datos_limpios <- datos %>% 
  filter(!is.na(body_mass_g))

head(datos_limpios, 4)
```

## Transformar variables

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 5. Transformar: crear nueva variable
datos_limpios_kg <- datos_limpios %>%
  mutate(body_mass_kg = body_mass_g / 1000)

ggplot(data = datos_limpios_kg, aes(x = island, y = bill_length_mm)) + geom_boxplot()

```

## Poco a poco más complejo (+)

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"


ggplot(data = datos_limpios_kg, aes(x = bill_length_mm, y = bill_depth_mm)) + geom_point()

ggplot(data = penguins, aes(x = bill_length_mm, y = bill_depth_mm)) +
geom_point(aes(color = body_mass_g), alpha = .6) +
  scico::scale_color_scico(palette = "bamako", direction = -1)+ 
## custom axes scaling
scale_x_continuous(breaks = 3:6 * 10, limits = c(30, 60)) +
scale_y_continuous(breaks = seq(12.5, 22.5, by = 2.5), limits = c(12.5, 22.5)) +
## custom labels
labs(
title = 'Bill Dimensions of Brush-Tailed Penguins (Pygoscelis)',
subtitle = 'A scatter plot of bill depth versus bill length.',
caption = 'data = Gorman, Williams & Fraser (2014) PLoS ONE, graph = Cédric Scherer',
x = 'Bill Length (mm)',
y = 'Bill Depth (mm)',
color = 'Body mass (g)'
)+
theme_update(
axis.ticks = element_line(color = "grey92"),
axis.ticks.length = unit(.5, "lines"),
panel.grid.minor = element_blank(),
legend.title = element_text(size = 12),
legend.text = element_text(color = "grey30"),
plot.title = element_text(size = 18, face = "bold"),
plot.subtitle = element_text(size = 12, color = "grey30"),
plot.caption = element_text(size = 9, margin = margin(t = 15))
)
```

## Ejemplo datos inscripción curso

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"

library(here)
library(tidyverse)
library(tm)
library(wordcloud2)
library(readxl)

# se puede importar tablas desde excel, csv, ggsheets, txt...

datos_curso = read_excel(here("data/datos-curso.xlsx"))

# Vemos un resumen
str (datos_curso)
#View (datos_curso) # Se nos abre en Rstudio

```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
colnames(datos_curso) # Miramos las columnas que tiene
```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 3     # ancho en pulgadas
#| fig-height: 3    # alto en pulgadas
#| fig-align: "center"

datos_curso_filtrado <- datos_curso |>
  rename (curso = "Curso de la primera matrícula en el programa de doctorado",
         experiencia = "Cuéntanos tu experiencia con R",
         comentarios = "Observaciones",
         email = "Correo electrónico") |>
  select (curso, experiencia, comentarios, email) |>
  mutate (email = str_replace(email, "anonymous", "anónimo")) |>
  filter (curso == "2022-23")
  
words <- tolower(
                unlist(
                  strsplit(datos_curso_filtrado$experiencia, " ") ) ) 

words <- gsub("[[:punct:][:digit:]]", "",words)
stop_es <- stopwords("spanish")
words_clean <- words[!words %in% stop_es]

# Plot
wordcloud2(data=table(words_clean), size=0.5,
           color = rep(RColorBrewer::brewer.pal(11, "PRGn"), 20))


```

## Visualizacion de datos

## DATA VIZZZZZZ

Colores...
https://www.fabiocrameri.ch/colourmaps/

## Desde gráficos muy simples

```{r}
#| echo: true
plot(x=rnorm(100), y=rnorm(100))
```

------------------------------------------------------------------------

## Hasta gráficos muy complejos

![quién habla con quién en "The Office"](images/complex_graph.png) [Código](https://r-graph-gallery.com/character-interaction-analysis.html)

## Mapas I

![Mapa del crecimiento urbano en Valencia](images/map-growth.png) [Código](https://dominicroye.github.io/blog/visualize-urban-growth/index.html)

## Mapas II 

![Apicultores en Alemania](images/bee.png) 
[Código](https://www.cedricscherer.com/top/dataviz/)

## Nuestros datos georeferenciados

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"

library(rgbif)
library(ggplot2)
library(rnaturalearth)
library(sf)

datos <- occ_search(scientificName = "Lynx pardinus", limit = 100)
#head(datos$data[, c("species", "decimalLatitude", "decimalLongitude")])
df <- datos$data

# Basic map
world <- ne_countries(scale = "medium", returnclass = "sf")

# Plot
ggplot() +
  geom_sf(data = world, fill = "black", color = "grey30") +
  geom_point(data = df, aes(x = decimalLongitude, y = decimalLatitude),
             color = "darkred", size = 2, alpha = 0.7) +
  coord_sf() +
  theme_minimal()

```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"

# Basic map
spain <- ne_countries(country=c("spain", "portugal"))
plot(spain)
# Plot

ggplot() +
  geom_sf(data = spain, fill = "grey99", color = "grey30") +
  geom_point(data = df, aes(x = decimalLongitude, y = decimalLatitude),
             color = "darkgreen", size = 2, alpha = 0.7) +
  coord_sf() +
  theme_minimal()

```

#### Mapa plantas

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
#| fig-width: 9.5     # ancho en pulgadas
#| fig-height: 9  # alto en pulgadas
#| fig-align: "left"
library(FloraIberica)
map_distribution(genus = "Lavandula", species = "stoechas", size = 0.9)
```

## Visualizaciones geniales (ya no solo con r)

[Valentina de Filippo](https://www.behance.net/valentinadefilippo?locale=es_ES)

## Bibliografía

https://www.tandfonline.com/doi/full/10.1080/00031305.2017.1375989#d1e199
