---
title: "Manejo y visualizaci√≥n de datos"
subtitle: "Importar, transformar y visualizar datos en R"
format: 
  revealjs:
    theme: solarized 
    smaller: true
    slide-number: true 
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

## Manejo de datos

### La exploraci√≥n de datos es el primer paso para:

-   Verificar su calidad
-   Comprender la informaci√≥n con la que trabajamos
-   Detectar errores o valores at√≠picos
-   Preparar los datos para su an√°lisis o visualizaci√≥n

### ¬øQu√© es ‚Äútidy data‚Äù?

Un conjunto de datos est√° ordenado (tidy) cuando:

-   Cada variable tiene su propia columna
-   Cada observaci√≥n tiene su propia fila
-   Cada valor tiene su propia celda

![Ejemplo organizaci√≥n "tidy"](images/tidy-table.png)

## Buenas pr√°cticas de sintaxis en R

::::: columns
::: {.column width="50%"}
### Espacios y asignaciones

-   Usa espacios alrededor de los operadores
-   Usa \<- en vez de =
-   Cuando haya funciones con el mismo nombre, especifica el paquete (dplyr::select ())
-   Empieza tu script con una descripci√≥n sobre lo que hace el c√≥digo, autorx, fecha y sesi√≥n.

### Organizaci√≥n de carpetas

-   Carpeta con los datos brutos
:::

::: {.column width="50%"}
!["carpetas"](images/folders.png)
:::
:::::


## Buenas pr√°cticas en el manejo de datos


#### üìã Estructura y formato

-   Cada variable en una columna
-   Cada observaci√≥n en una fila
-   No combines varias informaciones en una misma celda

#### üß© Nombres y valores

-   Evita espacios, n√∫meros o caracteres especiales en los nombres de columnas
-   Anota los ceros (0) cuando existen ‚Äî no los dejes vac√≠os!!
-   Usa NA o celdas vac√≠as para indicar datos faltantes
-   Separa las fechas en columnas: year, month, day

#### üíæ Registro y reproducibilidad

-   Realiza todas las manipulaciones de datos mediante c√≥digo, no manualmente
-   As√≠ dejas rastro reproducible de cada cambio
-   Guarda o exporta tus datos en formatos de texto plano (.csv, .txt)
-   m√°s universales, m√°s f√°ciles de versionar con Git

## Organizacion tabla

![Hertz & McNeill 2024](images/example-table.png){style="font-size:30px"}

## Tidyverse

El universo ordenado.

El tidyverse es una colecci√≥n de paquetes de R - Para hacer m√°s f√°cil y coherente el trabajo con datos. - Todos comparten una filosof√≠a com√∫n: - Filosof√≠a: Los datos deben ser ordenados (tidy), el c√≥digo legible y los resultados reproducibles

## C√≥digo limpio

-   Comentarios √∫tiles
-   Divide en pasos l√≥gicos
-   Usa bien la sangr√≠a y los espacios
-   Usa bien los nombres
-   Guarda solo objetos √∫tiles (R se va llenando)

## Tips

-   control + shift + C (des)comenta todo a la vez
-   control + shift + A reformatea el c√≥digo
-   control + click se abre la tabla en RStudio

## Importar los datos

```{r}
#| echo: true

library(dplyr)
library(here)

glimpse(iris) # datos incluidos en dplyr

cobertura <- read.csv(here("data/cobertura.csv"))
glimpse(cobertura)


```

------------------------------------------------------------------------

### Pipes: c√≥mo encadenar operaciones

Los "pipes" permiten escribir c√≥digo paso a paso, de forma legible:

```{r}
#| echo: true

library(dplyr)

# El propio de dplyr
iris %>%
  filter(Sepal.Length > 5) %>%
  summarise(promedio = mean(Sepal.Width))
# (control  (command) + shift + M)

# el de R desde hace unos a√±os
iris |>
  filter(Sepal.Length > 5) |>
  summarise(promedio = mean(Sepal.Width))

```

## Empecemos a manejar datos

Cosas importantes!

-   Primero pensar qu√© queremos hacer con los datos
-   El orden donde ponemos los argumentos
-   Si van dentro de par√©ntesis o no
-   d√≥nde va la base de datos a la que hacemos referencia

## Ejemplo datos de ping√ºinos

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 1. Cargar librer√≠as

library(dplyr)
library(ggplot2)
library(readr)
library(palmerpenguins)
library(scico)

# 2. Leer datos
data(package = 'palmerpenguins')

# 3. Explorar
glimpse (penguins)

unique(penguins$island)

datos_filtrados <- penguins %>% filter (year == 2007)

datos_filtrados <- penguins %>% filter (year == 2007, sex == "female")

datos_filtrados <- penguins %>% filter (year == 2007, sex == "female", island %in% c("Dream", "Bicoe"))
# island == c("Dream", "Bicoe")) NO VALE!
# summarize
head (datos_filtrados, 3)

penguins %>%
  filter(species == "Adelie") %>%
  summarise(promedio_pico = mean(bill_length_mm, na.rm = TRUE))

```

## Limpiar los datos

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 4. Limpiar: eliminar filas con NA
datos_limpios <- penguins %>%
  filter(!is.na(body_mass_g))

head(datos_limpios, 4)
```

## Transformar variables

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
 
# 5. Transformar: crear nueva variable
datos_limpios_kg <- datos_limpios %>%
  mutate(body_mass_kg = body_mass_g / 1000)
```

## Ejemplo datos inscripci√≥n curso

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"

library(here)
library(tidyverse)
library(tm)
library(wordcloud2)
library(readxl)

# se puede importar tablas desde excel, csv, ggsheets, txt...

datos_curso = read_excel(here("data/datos-curso.xlsx"))


```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
colnames(datos_curso) # Miramos las columnas que tiene
```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 3     # ancho en pulgadas
#| fig-height: 3    # alto en pulgadas
#| fig-align: "center"

datos_curso_filtrado <- datos_curso |>
  rename (
    curso = "Curso de la primera matr√≠cula en el programa de doctorado",
    experiencia = "Cu√©ntanos tu experiencia con R",
    comentarios = "Observaciones",
    email = "Correo electr√≥nico"
  ) |>
  select (curso, experiencia, comentarios, email) |>
  mutate (email = str_replace(email, "anonymous", "an√≥nimo")) |>
  filter (curso == "2022-23") # filtrado y sin filtrar otra diapo.
  
words <- tolower(unlist(strsplit(datos_curso_filtrado$experiencia, " ")))

words <- gsub("[[:punct:][:digit:]]", "", words)
stop_es <- stopwords("spanish")
words_clean <- words[!words %in% stop_es]

# Plot
wordcloud2(
  data = table(words_clean),
  size = 0.5,
  color = rep(RColorBrewer::brewer.pal(11, "PRGn"), 20)
)


```

## Ejercicios manejo de datos

Mismo ejercicio que ayer pero con dplyr.

Base de datos de flores: Por cada sitio y pantrap, tenemos el numero de flores que tienen las especies de plantas en Do√±ana. code = c√≥digo de la planta

Ejercicio: Importa la base de datos "flores.csv" de la carpeta "data", explora la base de datos, calcula la abundancia media de flores total, indica cuantas especies distintas hay de plantas. Luego, crea una base de datos con el n√∫mero de individuos por especie (no de flores). Guardala como csv.

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"

flores <- read.csv(here("data/flores.csv"))

# Estructura de los datos
glimpse(flores)

# Promedio de abundancia
flores %>% 
  summarise (media_abundancia = mean(abundance, na.rm = TRUE))

# N√∫mero de especies √∫nicas
flores %>% 
  summarise (n_especies = n_distinct(species))

# Listado de especies √∫nicas
flores %>% 
  distinct(species)

# Conteo de registros por especie
flores %>% 
  count(species, sort = TRUE)




```
