---
title: "Análisis multivariante"
subtitle: "PCA y NMDS"
format: 
  revealjs:
    theme: white    # Specify the 'night' theme here
    slide-number: true  # Optional: Show slide numbers
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

- Introducción

- Análisis de componentes principales (PCA)

- Escalamiento multidimensional no métrico (NMDS)

***

## Introducción

Método estadístico que analice simultáneamente múltiples características en cada muestra objeto de estudio.

Algunos ejemplos:

- Análisis de componentes principales

- Análisis de correspondencias

- Escalamiento multidimensional

- Análisis de correspondencias canónico

- Etc.

::: {.center .middle}
## Análisis de componentes principales (PCA)
:::

***

El objetivo es reducir un gran número de variables perdiendo la menor cantidad de información posible.

Los nuevos componentes principales o factores serán una combinación lineal de las variables originales e independientes entre sí.

La interpretación de los factores se deducirá observando su relación con las variables iniciales.

***

Fases:

1. Anállisis de la matriz de correlaciones. Deben existir altas correlaciones entre las variables.

2. Selección de los factores. El primer factor recoje la mayor proporción de variabilidad original, el segundo, la máxima no recogida pro el rpimero, etc.

3. Análisis de la matriz factorial. SE representan los factores seleccionados en forma de matriz. 

4. Interpretación de los factores

5. Cálculo de las puntuaciones factoriales.

***

::: {.center .middle}
### Ejemplo modelación riqueza plantas exóticas a partir del clima
:::

***

Modelar riqueza de especies exóticas utilizando variables climáticas.

```{r}
#| echo: true
clima <- read.table("exoticas.txt", header = T, sep = "\t")
str(clima)
```

Alien : variable respuesta

***

```{r}
#| echo: true
#| fig-width: 10     # ancho en pulgadas
#| fig-height: 8    # alto en pulgadas
#| fig-align: "center"
library(corrgram)
corrgram(clima[,-1], lower.panel=panel.pts, upper.panel=panel.conf, diag.panel=panel.density)
```

***

PCA para reducir la dimensionalidad y utilizar factores principales para modelar la riqueza de especies exóticas

```{r}
#| echo: true
pca_1 <- prcomp(clima[,-1], scale = T)
summary(pca_1)
pca_1$rotation[,1:2]
```

***

```{r}
#| echo: true
#| fig-width: 10     # ancho en pulgadas
#| fig-height: 8    # alto en pulgadas
#| fig-align: "center"
library(factoextra)
fviz_pca_var(pca_1, col.var = "black")
```

***

##### Ajustar modelo estadístico riqueza especies exóticas frente a los dos ejes principales

```{r}
#| echo: true
clima$pca1 <- pca_1$x[,1]
clima$pca2 <- pca_1$x[, 2]
glm_exoticas1 <- glm(Alien ~ pca1 + pca2, clima, family = "poisson")
anova(glm_exoticas1)
```

***

#### Supuestos del modelo

```{r}
#| echo: true
#| fig-width: 9.5     # ancho en pulgadas
#| fig-height: 9  # alto en pulgadas
#| fig-align: "left"
par(mfcol=c(2,2))
plot(glm_exoticas1)
library(aods3)
gof(glm_exoticas1)
```

***

#### Modelo binomial negativo

```{r}
#| echo: true
#| fig-width: 9.5     # ancho en pulgadas
#| fig-height: 9  # alto en pulgadas
#| fig-align: "left"
library(MASS)
glm_exoticas2 <- glm.nb(Alien ~ pca1 + pca2, clima)
par(mfcol=c(2,2))
plot(glm_exoticas2)
gof(glm_exoticas2)
```

***

```{r}
#| echo: true
anova(glm_exoticas2)
```

***
```{r}
#| echo: true
#| fig-width: 15     # ancho en pulgadas
#| fig-height: 9  # alto en pulgadas
#| fig-align: "left"
library(visreg)
par(mfcol=c(1,2))
visreg(glm_exoticas2, scale="response", ylab="Riqueza de especies")
```

::: {.center .middle}
## Escalamiento multidimensional no métrico (NMDS)
:::

***

[Representación en un espacio geométrico de pocas dimensiones las distancias existentes entre un conjunto de datos.]{style="font-size:30px"}

[1. Cálculo matriz de disimilaridad *X* a partir de la matriz de datos.]{style="font-size:25px"}

[2. Asignación de unidades muestrales a una configuración inicial aletaoria.]{style="font-size:25px"}

[3. Cálculo distancias otra vez en este nuevo espacio geométrico y se calcula una matriz de distancia *Y*]{style="font-size:25px"}

[4. Se comparan las matrices de distancia *X* e *Y* y se miden cómo son de parecidas entre ellas (stress)]{style="font-size:25px"}

[5. A partir de la configuración inicial, se reasignan las unidades muestrales para reducir las distancia con la matriz *X*]{style="font-size:25px"}

[6. Repetición iterativa del proceso hasta que se consigue una solución óptima (se minimiza el stress)]{style="font-size:25px"}

::: {.center .middle}
## Gradiente de composición florística en bosques tropicales montanos
:::

***

Investigar qué variables ambientales afectan a la composición florística de árboles en distintos tipos de bosques tropicales. Abundancia de cada especie en cada parcela.

1. Explora visualmente cómo son de similares las parcelas muestreadas en función de la composición de especies

2. Investigar relación de esta ordenación y las variables ambientales.


```{r}
#| echo: true
bio <- read.table("MANOVA-bio.txt", header=T, sep="\t")
env <- read.table("MANOVA-env.txt", header=T, sep="\t")
```

***

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
library(vegan)
set.seed(0)
nmds_1 <- metaMDS(bio, distance = "bray", try = 200, trymax = 200)
```

***

```{r}
#| echo: true
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
plot(nmds_1)
```

***

#### Gráfico mostrando las diferencias por tipo de bosque y mostrando relación lineal con variables

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.4em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
coordenadas <- as.data.frame(scores(nmds_1)$sites)
coordenadas$Forest = env$Forest
envfit_res <- envfit(nmds_1, env, permutations = 999)
env_vectors <- as.data.frame(scores(envfit_res, display = "vectors"))
env_vectors$Variable <- rownames(env_vectors)

ggplot(coordenadas, aes(x = NMDS1, y = NMDS2))+ 
  geom_point(size = 4, aes( shape = Forest, colour = Forest)) +
# Vectores ambientales (flechas)
  geom_segment(data = env_vectors,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.3, "cm")),
               color = "black") +
  # Nombres de las variables
  geom_text(data = env_vectors,
            aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Variable),
            color = "black",
            size = 4) 
```



