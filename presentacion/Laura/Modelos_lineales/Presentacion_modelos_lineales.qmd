---
title: "Modelos lineales"
subtitle: "Regresión y factoriales (ANOVA y ANCOVA)"
format: 
  revealjs:
    theme: solarized    # Specify the 'night' theme here
    slide-number: true  # Optional: Show slide numbers
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

## Organización del día

::::: columns
::: {.column width="50%"}
Hora

- 9:30 a 10:30 teoría

- 10:30 a 11:30 ejercicios

- 11:30 a 11:45 break

- 11:45 a 12:45 teoría

- 12:45 a 13:30 ejercicios y dudas
:::

::: {.column width="50%"}
Temario

- Modelos lineales regresión

- Ejercicio regresión

-

- Modelos lineales factoriales

- Ejercicio ANCOVA
:::
:::::

## Introducción modelos lineales

-   Definición

-   Tipos

-   Supuestos

-   Flujo de trabajo

## Definición

[Relación lineal entre dos o más variables, dependiendo una (variable dependiente) de la(s) otra(s) (variable(s) explicativa(s))]{style="font-size:25px"} 

[Variable dependiente: *y*]{style="font-size:25px"} 
[Variable(s) explicativa(s): *x*]{style="font-size:25px"} 

[Modelo matemático lineal: *y = 2x* o *y = 3 - 2x*]{style="font-size:25px"}

```{r}
#| echo: false
#| fig-width: 13    # ancho en pulgadas
#| fig-height: 8    # alto en pulgadas
library(palmerpenguins)
library(ggplot2)
data(penguins)
ggplot(data = penguins, aes(x = flipper_length_mm, y = body_mass_g)) +  
  geom_smooth(method='lm', formula= y~x, se = FALSE) +
  geom_point(color = "black", size = 1) +      
  labs(x = "x",         
       y = "y",                   
  ) +
  theme_minimal()  
```

***

### Objetivos

1.  Descripción de la relación

2.  Inferencia o generalización de los resultados

3.  Predicciones

## Tipos

Variable dependiente: siempre cuantitativa

Variables explicativas:

-   Cuantitativas: modelos de regresión (simple o múltiple)

-   Cualitativas o categóricas: ANOVA

-   Cuantitativas y categóricas: ANCOVA

## Supuestos del modelo

1.  Independencia

2.  Linealidad

3.  Normalidad

4.  Homocedasticidad

***

## Flujo de trabajo

![Pasos a seguir análisis de datos con modelos lineales (Cayuela y de la Cruz, 2022)](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/Flujo.png)


::: {.center .middle}
## Regresión simple y regresión múltiple
:::

------------------------------------------------------------------------

### Estructura

Ecuación regresión: 

Parte determinista: *y~i~ = β~0~ + β~1~ x~1~ + Ɛ~i~*

Parte estocástica: *Ɛ~i~ ~ N(0,σ^2^)*

[*β~0~*: ordenada en el origen]{style="font-size:25px"}

[*β~1~*: pendiente]{style="font-size:25px"}

[*Ɛ~i~*: residuos]{style="font-size:25px"}

***

Residuos

![Visualización modelo lineal](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/Residuos.jpg){width="700px" height="550px" fig-align="left"}

***

![Normalidad y homocedasticidad en los residuos](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/Normalidad.jpg){width="700px" height="500px" fig-align="left"}

[Ajuste modelo lineal]{style="font-size:30px"}

[Función lm(y \~ x)]{style="font-size:25px"}

------------------------------------------------------------------------

### Ejemplo

Pregunta: Masa corporal especies pingüinos y cómo esta es influenciada por la longitud de la aleta de los pingüinos

***

Hipótesis

*H~0~* (hipótesis nula): no existe relación entre la masa corporal de los pingüinos y la longitud de sus aletas

::: r-stack
*H~0~ : β~1~ = 0*
:::

*H~1~* (hipótesis alternativa): pendiente de la recta que relaciona masa corporal con longitud aleta es distinta de cero

::: r-stack
*H~0~ : β~1~ ≠ 0*
:::

------------------------------------------------------------------------

#### 1. Leer los datos en R y explorar gráficamente la relación entre las variables

```{r}
#| echo: true
library(palmerpenguins)
data(penguins)
head(penguins)
# eliminamos NAs variables que vamos a utilizar y pasamos masa corporal a kg
library(dplyr)
penguins_clean <- penguins %>%
  filter(!is.na(flipper_length_mm), !is.na(body_mass_g))
penguins_clean$body_mass_kg <- penguins_clean$body_mass_g/1000
```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.8em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
library(ggplot2)
ggplot(data = penguins_clean, aes(x = flipper_length_mm, y = body_mass_kg)) +  
  geom_point(color = "blue", size = 2) +      
  labs(x = "Longitud aleta (mm)",         
       y = "Masa corporal (kg)",                   
      title = "Relación entre masa corporal y longitud aleta "   
  ) +
  theme_minimal()        
```

------------------------------------------------------------------------

#### 2. Ajuste modelo de regresión

```{r}
#| echo: true
lm_reg1 <- lm(body_mass_kg ~ flipper_length_mm, data = penguins_clean)
```

***

#### 3. Variación explicada por el modelo y resolución hipótesis

[Tabla del análisis de la varianza]{style="font-size:30px"}

```{r}
#| echo: true
anova(lm_reg1)
```

[Suma de cuadrados: variabilidad de la variable *y*]{style="font-size:27px"}

[Coeficiente de determinación (R^2^): proporción de la variabilidad de *y* que es explicada por el modelo (0-1)]{style="font-size:27px"}

------------------------------------------------------------------------

#### 4. Interpretación del modelo

```{r}
#| echo: true
summary(lm_reg1)
```

[*y = 0.05x - 5.78*]{style="font-size:32px"}

[Fiabilidad estimadores para predecir]{style="font-size:30px"}

[R^2^ y R^2^ ajustado]{style="font-size:30px"}

------------------------------------------------------------------------

#### 5. Predicciones con el modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
library(broom)
library(tidyverse)
library(dplyr)
preds <- augment(lm_reg1, type.predict = "response", se_fit = TRUE)
preds <- preds %>%
  mutate(lower = .fitted - 1.96 * .se.fit,upper = .fitted + 1.96 * .se.fit)
ggplot(data = preds, aes(x = flipper_length_mm, y = body_mass_kg)) +  
  geom_point(color = "blue", size = 2) +     
  geom_line(aes(y = .fitted)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  labs(x = "Longitud aleta (mm)",         
       y = "Masa corporal (kg)",                   
      title = "Predicciones modelo de regresión"   
  ) +
  theme_minimal()        
```

***
 
#### 6. Revisión supuestos del modelo

[Supuestos de linealidad, normalidad y homocedasticidad]{style="font-size:27px"}

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(lm_reg1)      
```

***

[Supuestos linealidad, normalidad, homocedasticidad]{style="font-size:30px"}

![Residuos frente a valores predichos](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/supuestos1.png){width="725px" height="350px" fig-align="left"}

***

[Supuesto normalidad]{style="font-size:30px"}

![Gráfico Q-Q](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/supuestos2.png){width="725px" height="350px" fig-align="left"}

***

[Supuesto homocedasticidad]{style="font-size:30px"}

![Gráfico dispersión varianza residual](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/supuestos3.png){width="725px" height="350px" fig-align="left"}

***

[Datos sobreinfluyentes en el análisis]{style="font-size:30px"}

![Valores distancia de Cook](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/supuestos4.png){width="725px" height="350px" fig-align="left"}

***
[Normalidad:]{style="font-size:30px"}
```{r}
#| echo: true
shapiro.test(residuals(lm_reg1))
```

***

[Linealidad:]{style="font-size:30px"}
```{r}
#| echo: true
library(lmtest)
resettest(lm_reg1)
```

***

[Homocedasticidad:]{style="font-size:30px"}
```{r}
#| echo: true
library(car)
ncvTest(lm_reg1)
```
[Si no se cumplen supuestos del modelo: transformación variables (logarítmica, raíz cuadrada, Box-Cox, log-log, etc.)]{style="font-size:30px"}

***

### Regresión múltiple

*y~i~ = β~0~ + β~1~x~1~ + ... + β~1~x~n~ + Ɛ~i~*

*Ɛ~i~ ~N(0,σ^2^)*

***

### Dificultades

Multicolinealidad: dos o más predictores muy correlacionados entre sí. Aportan información redundante al modelo.

Consecuencias:

- Coeficientes pueden volverse inestables

- Los p-valores de los coeficientes se vuelven poco fiables

***

[Suma de cuadrados tipo I o III]{style="font-size:35px"}

![Suma de cuadrados: tipos (Cayuela y de la Cruz,) 2022](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/sumacuadrados.png){width="800px" height="225px" fig-align="left"}

[Suma de cuadrados tipo I: anova()]{style="font-size:25px"}

[Suma de cuadrados tipo III: Anova(lm,type="III")(library(car))]{style="font-size:25px"}

::: {.center .middle}
## Modelos factoriales: ANOVA y ANCOVA
:::

***

### Análisis de la varianza (ANOVA)

Hipótesis: comparación medias distintos grupos (niveles de factor)

*H~0~*: medias de los grupos son iguales

*H~0~: µ~a~ = µ~b~ = ... = µ*

*H~1~*: al menos una media es distinta a las demás

*H~0~: Ǝµ~j~ ≠ µ*

***

### Ejemplo

Pregunta: Diferencias ratio del pico (longitud/profundidad) de tres especies de pingüino

***

Hipótesis

*H~0~* (hipótesis nula): no existe diferencias en las medias del ratio del pico para las tres especies

::: r-stack
*H~0~ : µ~adelie~ = µ~gentoo~ = µ~chinstrap~ = µ*
:::

*H~1~* (hipótesis alternativa): la media de al menos una de las tres especies es distinta a las demás

::: r-stack
*H~0~ : Ǝµ~j~ ≠ µ*
:::

***

#### 1. Explorar gráficamente la relación entre las variables

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.8em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
penguins2 = penguins %>%
  mutate(bill_ratio = bill_length_mm / bill_depth_mm)
ggplot(data = penguins2, aes(x = species, y = bill_ratio, fill = species)) +  
  geom_boxplot(alpha = 0.8, color = "gray30") +
  scale_fill_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
  labs(x = "Species",         
       y = "Ratio del pico",                   
      title = "Diferencias ratio del pico entre especies"   
  ) +
  theme_minimal()        
```

***

#### 2. Ajuste modelo factorial

```{r}
#| echo: true
penguins2 <- penguins2 %>%
  mutate(species = as.factor(species))
lm_reg2 <- lm(bill_ratio ~ species, data = penguins2)
```

***

#### 3. Variación explicada por el modelo y resolución hipótesis

Tabla de análisis de la varianza

```{r}
#| echo: true
anova(lm_reg2)
```

***

#### 4. Interpretación del modelo 

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.5em'"
summary(lm_reg2)
```

[Variables indicadoras o variables *dummy*. Un nivel es la coordenada en el origen (nivel de referencia)]{style="font-size:20px"}

[*y~i,j~ = β~1~x~1~ + β~2~x~2~ + β~3~x~3~ + Ɛ~i~*]{style="font-size:25px"}

[*y~i~* = 2.12 + 0.53*Chinstrap* + 1.06*Gentoo*]{style="font-size:25px"}

***

#### Ver el nivel de referencia


```{r}
#| echo: true
 contrasts(penguins2$species)
```

***

#### Comparaciones *post-hoc* entre los distintos grupos

```{r}
#| echo: true
library(multcomp)
posthoc_species <- glht(lm_reg2, linfct=mcp(species="Tukey"))
summary(posthoc_species)
```

***

#### 5. Representación gráfica diferencias significativas

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(data = penguins2, aes(x = species, y = bill_ratio, fill = species, color = species)) +  
  geom_boxplot(alpha = 0.8, color = "black") +
  geom_jitter(width = 0.15, alpha = 0.6, size = 2, shape=21, color="black") +
  scale_fill_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
  scale_color_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
 labs(x = "Species",         
       y = "Ratio del pico",                   
      title = "Diferencias longitud aleta entre especies"   
  ) +
  theme_minimal() +
  geom_text(data = penguins2[2,], aes(y = 4, label = "a"), color="black", 
            size=5, nudge_x = 0) +
  geom_text(data = penguins2[2,], aes(y = 4, label = "b"), color="black", 
            size=5, nudge_x = 1) +
  geom_text(data = penguins2[2,], aes(y = 4, label = "c"), color="black", 
            size=5, nudge_x = 2) 
```

***

#### 6. Revisión supuestos del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(lm_reg2)      
```

***

#### Cambiar nivel de referencia del factor

```{r}
#| echo: true
levels(penguins2$species)
penguins2$species <- relevel(penguins2$species, ref = "Gentoo")
levels(penguins2$species)
```

***

### Análisis de la covarianza (ANCOVA)

Hipótesis: homogeneidad de pendientes

*H~0~*: las pendientes son iguales

*H~1~*: al menos una pendiente es distinta a las demás

```{r}
#| echo: false
#| fig-width: 13    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
set.seed(123)
n <- 600
d <- factor(rep(c("A", "B", "C"), each = n / 3))
b <- rnorm(n, mean = 10, sd = 3)
c <- rnorm(n, mean = 50, sd = 10)
beta_b <- c(A = 1.0, B = 2.0, C = 4.0)
beta_c <- 0.5
intercept <- c(A = 5, B = 10, C = 15)
error <- rnorm(n, mean = 0, sd = 3)
a <- intercept[d] + beta_b[d] * b + beta_c * c + error
df <- data.frame(a, b, c, d)

library(broom)
lm_54 <- lm(a ~ b*d, data = df)
newdata <- expand.grid(
  b = seq(min(df$b), max(df$b), length.out = 100),
  d = levels(df$d)
)
predicciones <- augment(lm_54, newdata = newdata)

ej1 <- ggplot(df, aes(x = b, y = a, color = d)) +
  geom_point(alpha = 0.5) +
  geom_line(data = predicciones, aes(x= b, y = .fitted, group = d, color = d), size = 1.2) +
  scale_color_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
  theme_minimal()


lm_55 <- lm(a ~ c+d, data = df)
newdata <- expand.grid(
  c = seq(min(df$c), max(df$c), length.out = 100),
  d = levels(df$d)
)
predicciones <- augment(lm_55, newdata = newdata)

ej2 <- ggplot(df, aes(x = c, y = a, color = d)) +
  geom_point(alpha = 0.5) +
  geom_line(data = predicciones, aes(x= c, y = .fitted, group = d, color = d), size = 1.2) +
  scale_color_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
  theme_minimal()

library(patchwork)

ej2 + ej1
```

***

### Ejemplo

Pregunta: La masa corporal de los pingüinos se ve influenciada por la longitud de su pico, teniendo en cuenta el sexo del individuo

***

Hipótesis

*H~0~*: no hay relación entre la masa corporal y la longitud del pico 

*H~0~*: descontando el efecto de la longitud del pico (si existe), no hay relación entre la masa corporal y el sexo del pingüino

Homogeneidad de pendientes

Asunción adicional a las de ANOVA y regresión: relación entre la variable respuesta y la covariable (pendiente de la regresión) es la misma en todos los grupos (homogeneidad de pendientes)

***
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(subset(penguins, !is.na(sex)), aes(x = bill_length_mm, y = body_mass_g)) +
  geom_point(color = "steelblue", size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~ sex) +
  labs(
    title = "Relación longitud pico y masa corporal",
    x = "Longitud pico (mm)",
    y = "Masa corporal (g)"
  ) +
  theme_minimal()
```

***

#### Ajuste modelo 

```{r}
#| echo: true
lm_3 <- lm(body_mass_g ~ bill_length_mm*sex, data = penguins)
```

#### Comprobación de hipótesis

```{r}
#| echo: true
anova(lm_3)
```

***

```{r}
#| echo: true
lm_4 <- lm(body_mass_g ~ bill_length_mm+sex, data = penguins)
anova(lm_4)
```

***

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(subset(penguins, !is.na(sex)), aes(x = bill_length_mm, y = body_mass_g, color = sex)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("#F8BBD0", "#B3E5FC")) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Relación longitud pico y masa corporal",
    x = "Longitud pico (mm)",
    y = "Masa corporal (g)",
    color = "Sexo"
  ) +
  theme_minimal()
```

***
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(data = subset(penguins, !is.na(sex)), aes(x = sex, y = body_mass_g, fill = sex, color = sex)) +  
  geom_boxplot(alpha = 0.8, color = "black") +
  geom_jitter(width = 0.15, alpha = 0.6, size = 2, shape=21, color="black") +
  scale_fill_manual(values = c("#F8BBD0", "#B3E5FC")) +
  scale_color_manual(values = c("#F8BBD0", "#B3E5FC")) +
 labs(x = "Sexo",         
       y = "Masa corporal (g)",                   
      title = "Diferencias masa corporal entre sexo"   
  ) +
  theme_minimal() +
  geom_text(data = penguins[2,], aes(y = 6500, label = "a"), color="black", 
            size=5, nudge_x = 0) +
  geom_text(data = penguins[2,], aes(y = 6500, label = "b"), color="black", 
            size=5, nudge_x = 1)         
```

***

[Pendientes significativamente distintas]{style="font-size:25px"}

[Relación masa corporal con longitud de la aleta, teniendo en cuenta la especie]{style="font-size:20px"}
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 18    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(subset(penguins, !is.na(species)), aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(color = "steelblue", size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  facet_wrap(~ species) +
  labs(
    title = "Relación longitud aleta y masa corporal",
    x = "Longitud aleta (mm)",
    y = "Masa corporal (kg)"
  ) +
  theme_minimal()
```
***
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
datos_limpios <- penguins %>%
  filter(!is.na(flipper_length_mm))
lm_5 <- lm(body_mass_g ~ flipper_length_mm*species, data = datos_limpios)
anova(lm_5)
```

***
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
summary(lm_5)
```

[*y~i~ = -2535.84 - 501.36 Chinstrap - 4251.44 Gentoo + (32.83 + 1.74 Chinstrap + 21.79 Gentoo) flipper_length*]{style="font-size:28px"}

***
#### [Gráfica de predicciones]{style="font-size:25px"}

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.7em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
newdata <- expand.grid(
  flipper_length_mm = seq(min(datos_limpios$flipper_length_mm), max(datos_limpios$flipper_length_mm), length.out = 100),
  species = levels(datos_limpios$species)
)
predicciones_grid <- augment(lm_5, newdata = newdata)

ggplot(datos_limpios, aes(x = flipper_length_mm, y = body_mass_g, color = species)) +
  geom_point(alpha = 0.5) +
  geom_line(data = predicciones_grid, aes(x= flipper_length_mm, y = .fitted, group = species, color = species), size = 1.2) +
  scale_color_manual(values = c("#F8BBD0", "#C8E6C9", "#B3E5FC")) +
  labs(
    title = "ANCOVA: predicciones por especie",
    x = "Longitud aleta (mm)",
    y = "Masa corporal (g)",
    color = "Especie"
  ) +
  theme_minimal()
```

***

#### Supuestos del modelo
```{r}
#| echo: true
#| #| fig-width: 9    # ancho en pulgadas
#| fig-height: 7    # alto en pulgadas
par(mfrow=c(2,2))
plot(lm_5)
```
