---
title: "Modelos lineales"
subtitle: "Regresión y factoriales (ANOVA y ANCOVA)"
format: 
  revealjs:
    theme: white    # Specify the 'night' theme here
    slide-number: true  # Optional: Show slide numbers
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

## Introducción

-   Definición

-   Tipos

-   Supuestos

-   Flujo de trabajo

## Definición

Relación lineal entre dos o más variables, dependiendo una (variable dependiente) de la(s) otra(s) (variable(s) explicativa(s))

Modelo matemático lineal: y = 2x o y = 3 - 2x

### Objetivos

1.  Descripción de la relación

2.  Inferencia, o generalización de los resultados

3.  Predicciones

## Tipos

Variable dependiente: siempre cuantitativa

Variables explicativas:

-   Cuantitativas: modelos de regresión (simple o múltiple)

-   Cualitativas o categóricas: ANOVA

-   Cuantitativas y categóricas: ANCOVA

## Supuestos del modelo

1.  Independencia

2.  Linealidad

3.  Normalidad

4.  Homocedasticidad

## Flujo de trabajo

![Pasos a seguir análisis de datos con modelos lineales (Cayuela y de la Cruz, 2022)](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/Flujo.png)

------------------------------------------------------------------------

### Formular problema correctamente

1.  Comprender problema y contexto

2.  Comprender objetivo del estudio

3.  Plantear problema en términos estadísticos

4.  Entender bien los datos

::: {.center .middle}
## Regresión simple y regresión múltiple
:::

------------------------------------------------------------------------

### Estructura

![Ecuación regresión](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/Ecuacion_regresion.png){width="500px" height="100px" fig-align="left"}

[*β~0~*: ordenada en el origen]{style="font-size:25px"}

[*β~1~*: pendiente]{style="font-size:25px"}

[*Ɛ~i~*: residuos]{style="font-size:25px"}

### Ajuste modelo lineal

Función lm(y \~ x)

------------------------------------------------------------------------

### Ejemplo

Pregunta: Masa corporal especies pingüinos y cómo esta es influenciada por la longitud de la aleta de los pingüinos

Hipótesis

*H~0~* (hipótesis nula): no existe relación entre la masa corporal de los pingüinos y la longitud de sus aletas

::: r-stack
*H~0~ : β~1~ = 0*
:::

*H~1~* (hipótesis alternativa): pendienta de la recta que relaciona masa corporal con longitud aleta es distinta de cero

::: r-stack
*H~0~ : β~1~ ≠ 0*
:::

------------------------------------------------------------------------

#### 1. Leer los datos en R y explorar gráficamente la relación entre las variables

```{r}
#| echo: true
library(palmerpenguins)
data(penguins)
head(penguins)
```

------------------------------------------------------------------------

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.8em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
library(ggplot2)
ggplot(data = penguins, aes(x = flipper_length_mm, y = body_mass_g)) +  
  geom_point(color = "blue", size = 3) +      
  labs(x = "Longitud aleta (mm)",         
       y = "Masa corporal (g)",                   
      title = "Relación entre masa corporal y longitud aleta "   
  ) +
  theme_minimal()        
```

------------------------------------------------------------------------

#### 2. Ajuste modelo de regresión

```{r}
#| echo: true
lm_reg1 <- lm(body_mass_g ~ flipper_length_mm, data = penguins)
```

#### 3. Variación explicada por el modelo y resolución hipótesis

###### Tabla del análisis de la varianza

```{r}
#| echo: true
anova(lm_reg1)
```

[Suma de cuadrados: variabilidad de la variable *y*]{style="font-size:30px"}

[Coeficiente de determinación (R^2^): bondad de ajuste del modelo (0-1)]{style="font-size:30px"}

------------------------------------------------------------------------

#### 4. Interpretación del modelo

```{r}
#| echo: true
summary(lm_reg1)
```

[*y = 49.686x - 5780.831*]{style="font-size:32px"}

[Fiabilidad estimadores para predecir]{style="font-size:30px"}

[R^2^ y R^2^ ajustado]{style="font-size:30px"}

------------------------------------------------------------------------

#### 5. Predicciones con el modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
library(broom)
library(tidyverse)
library(dplyr)
preds <- augment(lm_reg1, type.predict = "response", se_fit = TRUE)
preds <- preds %>%
  mutate(lower = .fitted - 1.96 * .se.fit,upper = .fitted + 1.96 * .se.fit)
  
ggplot(data = preds, aes(x = flipper_length_mm, y = body_mass_g)) +  
  geom_point(color = "blue", size = 2) +     
  geom_line(aes(y = .fitted)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  labs(x = "Longitud aleta (mm)",         
       y = "Masa corporal (g)",                   
      title = "Predicciones modelo de regresión"   
  ) +
  theme_minimal()        
```

***
 
#### 6. Revisión supuestos del modelo

Supuestos de linealidad, normalidad y homocedasticidad

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(lm_reg1)      
```

***
[Normalidad:]{style="font-size:23px"}
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
shapiro.test(residuals(lm_reg1))
```
[Linealidad:]{style="font-size:23px"}
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
library(lmtest)
resettest(lm_reg1)
```
[Homocedasticidad:]{style="font-size:23px"}
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
library(car)
ncvTest(lm_reg1)
```
[No se cumplen supuestos del modelo: transformación variables (logarítmica, raíz cuadrada, Box-Cox, log-log, etc.)]{style="font-size:22px"}

***

### Regresión múltiple

*y~i~ = β~0~ + β~1~x~1~ + ... + β~1~x~n~ + Ɛ~i~*

*Ɛ~i~ ~N(0,σ^2^)*

Suma de cuadrados tipo I o III

![Suma de cuadrados: tipos (Cayuela y de la Cruz, 2022](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/Modelos_lineales/sumacuadrados.png){width="1000px" height="300px" fig-align="left"}

::: {.center .middle}
## Modelos factoriales: ANOVA y ANCOVA
:::

***

### Análisis de la varianza (ANOVA)

Hipótesis: comparación medias distintos grupso (niveles de factor)

*H~0~*: medias de los grupos son iguales

*H~0~: µ~a~ = µ~b~ = ... = µ*

*H~1~*: al menos una media es distinta a las demás

*H~0~: Ǝµ~j~ ≠ µ*

***

### Ejemplo

Pregunta: Diferencias longitud pico tres especies de pingüino

Hipótesis

*H~0~* (hipótesis nula): no existe diferencias en las medias de la longitud de los picos para las tres especies

::: r-stack
*H~0~ : µ~adelie~ = µ~gentoo~ = µ~chinstrap~ = µ*
:::

*H~1~* (hipótesis alternativa): la media de al menos una de las tres especies es distinta a las demás

::: r-stack
*H~0~ : Ǝµ~j~ ≠ µ*
:::

***

#### 1. Explorar gráficamente la relación entre las variables

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.8em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 5    # alto en pulgadas
#| fig-align: "center"
ggplot(data = penguins, aes(x = species, y = bill_length_mm, fill = species)) +  
  geom_boxplot(alpha = 0.8, color = "gray30") +
  scale_fill_manual(values = c("#F8BBD0", "#FFF9C4", "#B3E5FC")) +
  labs(x = "Species",         
       y = "Longitud pico (mm)",                   
      title = "Diferencias longitud pico entre especies"   
  ) +
  theme_minimal()        
```

***

#### 2. Ajuste modelo factorial

```{r}
#| echo: true
penguins$species <- as.factor(penguins$species)
lm_reg2 <- lm(bill_length_mm ~ species, data = penguins)
```

#### 3. Variación explicada por el modelo y resolución hipótesis

###### Tabla de análisis de la varianza

```{r}
#| echo: true
anova(lm_reg2)
```

***

#### 4. Interpretación del modelo y comparaciones *post-hoc*

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
summary(lm_reg2)
```

[Variables indicadoras o variables *dummy*]{style="font-size:20px"}

[*y~i,j~ = β~1~x~1~ + β~2~x~2~ + β~3~x~3~ + Ɛ~i~*]{style="font-size:20px"}

[Un nivel es la coordenada en el origen (nivel de referencia)]{style="font-size:20px"}

***
```{r}
#| echo: true
 contrasts(penguins$species)
```

[Ecuación: *y~i~* = 38.79 + 10.04*x~i~* + 8.71*x~2~*]{style="font-size:25px"}

```{r}
#| echo: true
library(multcomp)
posthoc_species <- glht(lm_reg2, linfct=mcp(species="Tukey"))
summary(posthoc_species)
```

***

#### 5. Representación gráfica diferencias significativas

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
ggplot(data = penguins, aes(x = species, y = bill_length_mm, fill = species, color = species)) +  
  geom_boxplot(alpha = 0.8, color = "black") +
  geom_jitter(width = 0.15, alpha = 0.6, size = 2, shape=21, color="black") +
  scale_fill_manual(values = c("#F8BBD0", "#FFF9C4", "#B3E5FC")) +
  scale_color_manual(values = c("#F8BBD0", "#FFF9C4", "#B3E5FC")) +
 labs(x = "Species",         
       y = "Longitud pico (mm)",                   
      title = "Diferencias longitud pico entre especies"   
  ) +
  theme_minimal() +
  geom_text(data = penguins[2,], aes(y = 65, label = "a"), color="black", 
            size=5, nudge_x = 0) +
  geom_text(data = penguins[2,], aes(y = 65, label = "b"), color="black", 
            size=5, nudge_x = 1) +
  geom_text(data = penguins[2,], aes(y = 65, label = "c"), color="black", 
            size=5, nudge_x = 2) 
```

***

#### 6. Revisión supuestos del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(lm_reg2)      
```

***

### Análisis de la covarianza (ANCOVA)

Hipótesis: homogeneidad de pendientes

*H~0~*: las pendientes son iguales

*H~1~*: al menos una pendiente es distinta a las demás

***