---
title: "Modelos lineales generalizados (GLMs)"
format: 
  revealjs:
    theme: white    # Specify the 'night' theme here
    slide-number: true  # Optional: Show slide numbers
    self-contained: true
  html: 
    self-contained: true
    code-fold: true
    code-summary: "Show the code"
    code-tools: true
    toc: TRUE
    toc-location: left
    toc-depth: 3
    theme: flatly
---

## Introducción

1.   Definición

2.   Estructura

     2.1. Función de vínculo

     2.2. Familia de distribución de errores

***

## 1. Definición

Supuestos modelos lineales:

1. Los errores se distribuyen nromalmente

2. La varianza (residual) es constante

3. La variable respuesta se relaciona linealmente con la(s) variable(s) independiente(s), si alguna de estas variables es continua

Uno o varios supuestos no se cumplen.

¿Qué hacer?

***

[GLMs: extensión modelos lineales especificando estructuras no normales de errores y varianzas no constantes.]{style="font-size:20px"}

[Modelos lineales caso particular de GLMs con distribución de errores normal y varianza constante.]{style="font-size:20px"}

![Relación varianza y media (Cayuela y de la Cruz, 2022)](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/GLM/media_varianza.png){width="500px" height="500px" fig-align="left"}

***

Tipos de variables que por definición violan supuestos modelos lineales:

- conteo de casos (p.ej. abundancia de especies)

- conteo de casos como proporciones (p.ej. porcentaje plántulas muertas en un experimento)

- respuesta binaria (p.ej. usado o no usado, presente o ausente)

***

## 2. Estructura

[3 componentes principales:]{style="font-size:30px"}

[1. El predictor lineal]{style="font-size:25px"}

[2. La función de vínculo]{style="font-size:25px"}

[3. La estructura de los errores]{style="font-size:25px"}

[Estructura modelos lineales:]{style="font-size:30px"}

[*y~i~ = β~0~ + β~1~x~1~ + ... + β~1~x~n~ + Ɛ~i~*]{style="font-size:25px"}

[*Ɛ~i~ ~N(0,σ^2^)*]{style="font-size:25px"}

[Estructura GLMs:]{style="font-size:30px"}

[*f(y~i~) = β~0~ + β~1~x~1~ + ... + β~1~x~n~ + Ɛ~i~*]{style="font-size:25px"}

[*Var(y) ~ f(µ)*]{style="font-size:25px"}

***

##### 2.1. La función de vínculo *f(y)*

[Transformación de la variable *y* buscando linealizar relación *y* con *x* y/o transformando en continuas variables que no lo son.]{style="font-size:25px"}

[Por tanto, cambia la naturaleza de la variable respuesta.]{style="font-size:25px"}

[Determinadas funciones de vínculo deben implementarse con determinados tipos de variables respuesta]{style="font-size:25px"}

![Función de vínculo (Cayuela y de la Cruz, 2022)](F:/Nextcloud13102025/CursoR/Github/curso-r-us/presentacion/Laura/GLM/funcion_vinculo.png){width="800px" height="300px" fig-align="left"}


***

##### 2.2. La familia de distribución de errores

a) Poisson: varianza aumenta linealmente con la media. Para respuestas tipo conteo.

b) Binomial negativa: extensión de Poisson. Para variables conteo con sobredispersión.

c) Binomial: para proporsiones y datos presencia/ausencia.

d) Gamma: para datos continuos con coeficiente de variación constante.

*** 
#### Ajuste GLM en R

Función glm()

Argumento family:

- binominal(link = "logit")
- gaussian(link = "identity)
- Gamma(link = "inverse")
- inverse.gaussian(link = "1/mu^2)
- poisson(link = "log")
- quasi(link = "identity", variance = "constant")

::: {.center .middle}
## Ejemplo con datos tipo conteo
:::

***

Efecto ganadería en regeneración de araucaria. Muestreo de número de plantas de araucaria en dos tipos de ganadería: pequeños propietarios, con uso más intensivo de la tierra, y grandes empresas forestales, que mantienen algunos remanente bosque nativo. Actividad ganado medida por número de bostas.

***

```{r}
#| echo: true
library(ADER)
data(ara)
str(ara)
```

Hipótesis:

*H0: β = 0* (pendiente entre plántulas y número de bostas es 0)

*H0: µ~1~ = µ~2~* (número plántulas en pequeños propietarios y empresas sin diferencias)

*H0: β~1~ = β~2~* (relación entre plántulas y bostas es igual en pequeños propietarios y empresas)

***

### Exploración gráfica de los datos

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.2em'"
#| fig-width: 9    # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "center"
library(ggplot2)
ggplot(ara, aes(x = dungs, y = seedlings)) +
  geom_point(color = "steelblue", size = 2) +
  facet_wrap(~ property) +
  labs(
    title = "Relación nº plántulas y nº bostas",
    x = "Nº bostas",
    y = "Nº plántulas"
  ) +
  theme_minimal()
```

***

#### Construcción modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
glm_arau1 <- glm(seedlings ~ dungs*property, ara, family = "poisson")
anova(glm_arau1)
```

[Devianza explicada por el modelo]{style="font-size:25px"}

[Medida de cantidad de variabilidad que explica el modelo (similar R^2^ en modelos lineales)]{style="font-size:25px"}

[*D^2^ = 1 - D~modelo~/D~nulo~*]{style="font-size:25px"}

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
print(D2 <- 1 - (198.02/347.56))
```

***
 
```{r}
#| echo: true
summary(glm_arau1)
```
[Fórmula: *log(y) = 2.497 + 0.576 Empresa + (-0.010 + 0.009 Empresa) Bostas*]{style="font-size:30px"}

***

#### Supuestos del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(glm_arau1)      
```

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
library(aods3)
gof(glm_arau1)      
```

***

### Modelo binomial negativo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
library(MASS)
glm_arau2 <- glm.nb(seedlings ~ dungs*property, ara)
summary(glm_arau2)
```

***

### Supuestos del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(glm_arau2)      
```

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
gof(glm_arau2)      
```

***
#### Predicciones modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
library(car)
Anova(glm_arau2, type = "III")      
```

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.6em'"
#| attr-output: "style='font-size: 0.3em'"
#| fig-width: 7     # ancho en pulgadas
#| fig-height: 7    # alto en pulgadas
#| fig-align: "left"
library(visreg)
visreg(glm_arau2, "dungs", by ="property", overlay = T, scale = "response", ylab = "Nº plántulas", xlab = "Nº bostas")
```

::: {.center .middle}
## Ejemplo con distribución de errores binomial
:::

***

2 variantes de estos modelos:

- Variable con valores binarios (1/0): modelos de regresión logística

- variables con valores porcentuales (nº éxitos / nº de ensayos)

Función de vínculo: logit *log(p/(1-p))*

*logit(y) = ln(p/(1-p)) = β~0~ + β~1~x~1~ + ... + β~1~x~n~*

Curva sigmoidea entre 0-1

::: {.center .middle}
## Ejemplo: Estrategia reproductora especie de alga invasora
:::

***

[Estrategia reproductora de un alga invasora con dos especies nativas.]{style="font-size:25px"}

[¿Probabilidad de encontrar estructuras reproductoras es diferente entre la especie invasora y las nativas?]{style="font-size:25px"}

[Hipótesis: la especie invasora tendrá mayor probabilidad de reproducrise que las nativas]{style="font-size:25px"}

```{r}
#| echo: true
#| #| attr-source: "style='font-size: 0.4em'"
#| attr-output: "style='font-size: 0.4em'"
library(ADER)
data(algas)
str(algas)
```

[Variable respuesta (Estado):]{style="font-size:25px"} 
     
     - 0: sin estructuras reproductoras
     - 1: con estructuras reproductoras

[Variables predictoras:]{style="font-size:25px"} 
     
     - talla del individuo (cm)
     - especie (Sp)
     
***

#### Exploración de los datos

```{r}
#| echo: true
#| #| attr-source: "style='font-size: 0.4em'"
#| attr-output: "style='font-size: 0.4em'"
ggplot(algas, aes(x = Long, y = Estado, color = Sp)) +
  geom_point(alpha = 0.4, position = position_jitter(height = 0.05)) +
facet_wrap(~Sp) +
  labs(
    x = "Talla individuo (cm)",
    y = "Estructura reproductora",
  ) +
  theme_minimal()
```

***

#### Ajuste del modelo
```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
glm_algas1 <- glm(Estado ~ Long*Sp, algas, family = "binomial")
anova(glm_algas1)
```

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
glm_algas2 <- glm(Estado ~ Long+Sp, algas, family = "binomial")
anova(glm_algas2)
print(D2 <- 1 - (341.6/476.38))
```

***

#### Supuestos del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.7em'"
#| attr-output: "style='font-size: 0.4em'"
#| fig-width: 6     # ancho en pulgadas
#| fig-height: 6    # alto en pulgadas
#| fig-align: "left"
par(mfrow=c(2,2))
plot(glm_algas2)      
```

***

### Estructura del modelo

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
summary(glm_algas2)
```

***

#### Gráfico de predicciones

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
#| fig-width: 10     # ancho en pulgadas
#| fig-height: 7    # alto en pulgadas
newdat <- expand.grid(
  Long = seq(min(algas$Long), max(algas$Long), length = 100),
  Sp = levels(algas$Sp)
)

# Predicciones de probabilidad
pred <- predict(glm_algas2, newdat, type = "link", se.fit = TRUE)

# Convertir de escala logit a probabilidad
newdat$fit <- plogis(pred$fit)
newdat$lwr <- plogis(pred$fit - 1.96 * pred$se.fit)
newdat$upr <- plogis(pred$fit + 1.96 * pred$se.fit)

ggplot(newdat, aes(x = Long, y = fit, color = Sp, fill = Sp)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.15, color = NA) +
  labs(
    x = "Talla individuo (cm)",
    y = "Predicción probabilidad estructuras reproductoras",
  ) +
  theme_minimal(base_size = 13)
```

***

Comparaciones entre especies

```{r}
#| echo: true
#| attr-source: "style='font-size: 0.5em'"
#| attr-output: "style='font-size: 0.3em'"
library(multcomp)
summary(glht(glm_algas2, linfct = mcp(Sp = "Tukey")))
```